# Интеграция ML модели в FastAPI

## Описание

ML модель для классификации неисправностей подшипников интегрирована в FastAPI приложение.

## Автоматическая загрузка модели

ML модель автоматически загружается при старте приложения через `lifespan` контекстный менеджер FastAPI.

## Новые эндпоинты

### 1. POST /api/v1/predict

Предсказывает состояние подшипника по вибрационным данным.

**Формат запроса:**
```json
{
  "vibration_data": [
    [0.1, 0.12, 0.11, 0.13, 0.09],  // Ось X
    [0.08, 0.10, 0.09, 0.11, 0.07],  // Ось Y
    [0.05, 0.06, 0.05, 0.07, 0.04]   // Ось Z (опционально)
  ],
  "temperature": 45.5,
  "sampling_rate": 1000.0
}
```

**Формат ответа:**
```json
{
  "состояние": "норма",
  "вероятность": 0.95,
  "рекомендация": "Продолжить мониторинг",
  "рекомендации": [
    "Продолжить мониторинг",
    "Проводить плановые проверки согласно графику"
  ],
  "метрики": {
    "уверенность_процентах": 95.5,
    "вероятности_классов": {
      "норма": 95.5,
      "износ внутреннего кольца": 2.1,
      "износ внешнего кольца": 1.8,
      "неисправность шарика": 0.6
    },
    "код_состояния": 0
  }
}
```

### 2. GET /api/v1/ml-status

Возвращает статус ML модели.

**Формат ответа:**
```json
{
  "загружена": true,
  "доступна": true,
  "путь_к_модели": "D:\\bearing_monitor\\ml_model\\bearing_classifier_model.joblib",
  "ошибка": null
}
```

## Модифицированный эндпоинт

### POST /api/v1/vibration-data

Теперь автоматически вызывает ML модель при сохранении данных.

**Новый формат ответа:**
```json
{
  "id": "uuid",
  "device_id": "motor_001",
  "timestamp": "2024-01-15T10:30:00",
  "message": "Данные вибрации успешно сохранены для устройства motor_001",
  "ml_prediction": {
    "состояние": "норма",
    "вероятность": 0.95,
    "рекомендация": "Продолжить мониторинг",
    "рекомендации": [...],
    "метрики": {...}
  }
}
```

Если ML модель недоступна, поле `ml_prediction` будет `null`, но данные все равно сохранятся.

## Обработка ошибок

- Если модель не загружена: возвращается HTTP 503 с описанием ошибки
- Если данные некорректны: возвращается HTTP 400 с описанием проблемы
- Если произошла внутренняя ошибка: возвращается HTTP 500

## Классификация состояний

Модель классифицирует 4 состояния:

1. **норма** - подшипник работает в штатном режиме
2. **износ внутреннего кольца** - требуется плановое обслуживание
3. **износ внешнего кольца** - требуется плановое обслуживание
4. **неисправность шарика** - критическое состояние, требуется немедленное внимание

## Примеры использования

### Python (requests)

```python
import requests

# Предсказание состояния
response = requests.post(
    "http://localhost:8000/api/v1/predict",
    json={
        "vibration_data": [
            [0.1, 0.12, 0.11] * 10,
            [0.08, 0.10, 0.09] * 10,
            [0.05, 0.06, 0.05] * 10
        ],
        "temperature": 45.5,
        "sampling_rate": 1000.0
    }
)
print(response.json())

# Сохранение данных с автоматическим предсказанием
response = requests.post(
    "http://localhost:8000/api/v1/vibration-data",
    json={
        "device_id": "motor_001",
        "timestamp": "2024-01-15T10:30:00",
        "vibration_x": [0.1, 0.12, 0.11],
        "vibration_y": [0.08, 0.10, 0.09],
        "vibration_z": [0.05, 0.06, 0.05],
        "sampling_rate": 1000.0,
        "temperature": 45.5
    }
)
print(response.json())
```

### cURL

```bash
# Предсказание состояния
curl -X POST "http://localhost:8000/api/v1/predict" \
  -H "Content-Type: application/json" \
  -d '{
    "vibration_data": [[0.1, 0.12, 0.11], [0.08, 0.10, 0.09], [0.05, 0.06, 0.05]],
    "temperature": 45.5,
    "sampling_rate": 1000.0
  }'

# Проверка статуса ML модели
curl "http://localhost:8000/api/v1/ml-status"
```

## Требования

- Файл модели должен находиться в `ml_model/bearing_classifier_model.joblib`
- Если модель не найдена, эндпоинты будут возвращать ошибку 503
- Для обучения модели выполните: `python ml_model/train_model.py`

