# Руководство по тестированию интеграции ML модели

## Описание

Этот документ описывает процесс тестирования полной интеграции ML модели с бэкендом и фронтендом.

## Предварительные требования

1. Обученная ML модель (`ml_model/bearing_classifier_model.joblib`)
2. Запущенный FastAPI сервер (`http://localhost:8000`)
3. Установленные зависимости:
   ```bash
   pip install -r backend/requirements.txt
   ```

## Скрипты для тестирования

### 1. test_integration.py

Полный тест интеграции ML модели с бэкендом.

**Использование:**
```bash
python test_integration.py
```

**Что делает:**
- Генерирует тестовые вибрационные данные для всех 4 состояний
- Отправляет их на endpoint `/api/v1/vibration-data`
- Проверяет корректность предсказаний ML модели
- Выводит отчет с точностью предсказаний
- Сохраняет результаты в файл `test_report.md`

**Результаты:**
- Общая точность предсказаний
- Точность по каждому классу
- Детальный отчет по каждому тесту
- Информация о модели

### 2. demo_script.py

Демонстрационный скрипт работы системы.

**Использование:**
```bash
python demo_script.py
```

**Что делает:**
- Показывает работу системы на примерах:
  - Нормальные данные → "Норма"
  - Износ внутреннего кольца → соответствующий диагноз
  - Износ внешнего кольца → соответствующий диагноз
  - Неисправность шарика → соответствующий диагноз
- Выводит красиво отформатированные результаты
- Показывает вероятности всех классов

## Новые API endpoints

### GET /api/v1/model-info

Возвращает информацию о ML модели.

**Ответ:**
```json
{
  "загружена": true,
  "путь_к_модели": "path/to/model.joblib",
  "количество_классов": 4,
  "классы": [
    "норма",
    "износ внутреннего кольца",
    "износ внешнего кольца",
    "неисправность шарика"
  ],
  "точность_обучения": 1.0,
  "дата_обучения": "2024-01-15T10:30:00",
  "версия_модели": "1.0.0",
  "размер_файла_мб": 0.5
}
```

## Логирование предсказаний

Все предсказания ML модели автоматически логируются в файл:
- `backend/logs/predictions.jsonl`

Формат лога (JSONL - одна строка JSON на запись):
```json
{
  "timestamp": "2024-01-15T10:30:00",
  "device_id": "motor_001",
  "vibration_data": {
    "vibration_x_count": 50,
    "vibration_y_count": 50,
    "vibration_z_count": 50,
    "sampling_rate": 1000.0,
    "temperature": 45.5
  },
  "prediction": {
    "состояние": "норма",
    "вероятность": 0.95,
    "рекомендация": "Продолжить мониторинг",
    ...
  }
}
```

## Примеры использования

### Тестирование через API

```python
import requests

# Отправка данных вибрации
response = requests.post(
    "http://localhost:8000/api/v1/vibration-data",
    json={
        "device_id": "motor_001",
        "timestamp": "2024-01-15T10:30:00",
        "vibration_x": [0.1, 0.12, 0.11],
        "vibration_y": [0.08, 0.10, 0.09],
        "vibration_z": [0.05, 0.06, 0.05],
        "sampling_rate": 1000.0,
        "temperature": 45.5
    }
)

# Получение информации о модели
model_info = requests.get("http://localhost:8000/api/v1/model-info")
print(model_info.json())
```

### Проверка логов

```python
from backend.app.prediction_logger import get_logger

logger = get_logger()
recent_predictions = logger.get_recent_predictions(limit=10)

for pred in recent_predictions:
    print(f"{pred['timestamp']}: {pred['prediction']['состояние']}")
```

## Интерпретация результатов

### Точность предсказаний

- **> 95%** - Отличная точность, модель работает корректно
- **90-95%** - Хорошая точность, возможны небольшие улучшения
- **< 90%** - Требуется переобучение модели или проверка данных

### Проверка по классам

Каждый класс должен иметь точность > 85%. Если какой-то класс имеет низкую точность:
- Проверьте качество тестовых данных для этого класса
- Убедитесь, что модель обучена на достаточном количестве данных
- Проверьте балансировку классов в обучающей выборке

## Устранение проблем

### API недоступен

```bash
# Убедитесь, что сервер запущен
cd backend
uvicorn app.main:app --reload
```

### Модель не загружена

```bash
# Обучите модель
cd ml_model
python train_model.py
```

### Ошибки при тестировании

1. Проверьте, что все зависимости установлены
2. Убедитесь, что модель обучена и находится в правильной директории
3. Проверьте логи сервера на наличие ошибок

## Дополнительная информация

- Документация API: http://localhost:8000/docs
- Статус ML модели: http://localhost:8000/api/v1/ml-status
- Информация о модели: http://localhost:8000/api/v1/model-info

